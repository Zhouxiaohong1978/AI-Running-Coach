# AI跑步教练 - 功能复用规划（完整版）

**版本：** 2.0
**日期：** 2026年1月26日
**项目名称：** AIRunningCoach
**总体复用率：** 95%（《地球新主》48,000行代码）

---

## 优化要点总结

- **架构统一**：全App MVVM + Coordinator + Repository（《地球新主》课程架构模式）
- **新增模块**：`AIManager.swift` 封装AI（OpenAI/Claude），复用 `SpeechManager`
- **测试驱动**：每阶段加 `xcodebuild test` 验证
- **主题&本地化**：`RunningTheme` + `L("key")`
- **MapKit优化**：强制用 `didUpdate userLocation` 回调
- **开发周期**：压缩至 **18天**（高复用 + Claude Code 加速）

---

## 项目概述

基于PRD和高复用"地球新主"核心功能，打造iOS跑步教练App。

**成功公式**：垂直跑步 + AI教练 + 订阅变现 + iOS优先

---

## 核心理念转换

| 地球新主游戏概念 | AI跑步教练对应 | 说明 |
|--------------|--------------|------|
| 圈地占领 | 跑步路线记录 | PostGIS闭合检测 + Coordinator导航 |
| 探索搜刮POI | 途经地标打卡 | MapKit `didUpdate userLocation` 触发 |
| 资源背包 | 运动装备/成就奖励 | ItemManager + 稀有度加成 |
| 建造系统 | 训练计划解锁 | AIManager生成JSON计划 |
| 交易系统 | 跑友装备交换 | 附近100m可见 |
| 通讯频道 | 跑步社群 | Supabase Realtime |
| 生存体征 | 运动健康监测 | HealthKit心率 + 疲劳衰减 |
| 排行榜 | 跑步排名 | 窗口函数优化 |
| 成就系统 | 跑步里程碑 | EventBus事件驱动 |
| 付费订阅 | 高级教练功能 | StoreKit2 + RevenueCat |

---

## 第一阶段：基础架构（第1-3天）

### 1.1 Supabase后端配置

**复用代码：** `AuthManager.swift`, `SupabaseClient.swift`

**任务：**
- [ ] 注册Supabase项目，启用PostGIS扩展
- [ ] 创建数据库表结构：
  - `users`（用户表）
  - `runs`（跑步记录表，geometry: geography(linestring,4326)）
  - `routes`（路线表）
  - `achievements`（成就表）
  - `items`（装备/奖励表）
  - `leaderboards`（排行榜表）
  - `messages`（消息表）
  - `subscriptions`（订阅记录表）
  - `training_plans`（训练计划表，plan_json: jsonb）
- [ ] 配置RLS（行级安全策略）+ Realtime
- [ ] **测试**：`xcodebuild test -scheme AIRunningCoach`

```sql
-- RLS示例
ALTER TABLE runs ENABLE ROW LEVEL SECURITY;
CREATE POLICY user_runs ON runs FOR ALL USING (auth.uid() = user_id);
```

### 1.2 用户认证系统 + Coordinator

**复用代码：** `AuthManager.swift` (380行，100%)
**新增**：`AuthCoordinator.swift`（~100行，导航Login/Register）

**功能：**
- 邮箱注册/登录
- Apple Sign In（一键登录）
- Google Sign In
- 密码找回
- 会话管理

**界面：**
- `LoginView.swift`（用 `L("login_title")` 本地化）
- `RegisterView.swift`
- `ForgotPasswordView.swift`

---

## 第二阶段：核心跑步功能（第4-6天）

### 2.1 GPS跑步追踪增强

**复用代码：** `LocationManager.swift` (950行，70%复用)
**优化**：`mapView(_:didUpdate userLocation:)` 自动居中轨迹

**现有功能：**
- ✓ 实时GPS定位
- ✓ 轨迹绘制
- ✓ 距离计算
- ✓ 配速计算

**新增功能：**
- [ ] 轨迹保存到Supabase（PostGIS）
- [ ] 路线"圈地"功能（跑完一圈自动闭合识别）
- [ ] 路线地理围栏检测
- [ ] 后台定位持续跟踪
- [ ] 离线SwiftData缓存 + 数据同步
- [ ] **测试**：模拟跑步，精度<10m

### 2.2 POI地标发现系统

**复用代码：** `POIManager.swift` (1400行，100%)

**功能：**
- [ ] 跑步途中自动识别附近地标
  - 公园 → 获得"户外跑步"徽章
  - 医院 → 获得"健康卫士"徽章
  - 商店 → 获得"补给站"标记
  - 景点 → 获得"探索者"称号
- [ ] 地理围栏触发（进入100米范围自动弹窗）
- [ ] MapKit本地POI数据（免费）
- [ ] 打卡签到功能

**界面：**
- `POIDiscoveryView.swift`（弹窗用Coordinator push）
- `POIDetailView.swift`（地标详情）

---

## 第三阶段：游戏化功能（第7-10天）

### 3.1 装备背包系统

**复用代码：** `ItemManager.swift` (600行，90%)

**功能：**
- [ ] 虚拟装备收集（跑鞋、运动服、智能手表等）
- [ ] 背包容量管理
- [ ] 装备属性加成（+5%配速、+10%耐力等）
- [ ] 装备穿戴/卸下
- [ ] 装备稀有度分级（普通/稀有/史诗/传说）

**数据模型：**
```swift
struct RunningItem {
    var id: UUID
    var name: String        // L("running_shoe")
    var type: ItemType      // 跑鞋/上衣/手表/配件
    var rarity: Rarity      // 普通/稀有/史诗/传说
    var attributes: [String: Double]  // ["pace_bonus": 0.05]
    var icon: String
}
```

### 3.2 成就系统

**复用代码：** `AchievementManager.swift` (800行，100%)

**成就类别：**

**新手成就：**
- [ ] "第一步"：完成首次跑步
- [ ] "坚持就是胜利"：连续跑步3天
- [ ] "破冰者"：累计跑步5km

**进阶成就：**
- [ ] "半马挑战"：单次跑步21km
- [ ] "全马挑战"：单次跑步42km
- [ ] "速度之王"：配速低于4'00"/km
- [ ] "百公里长征"：累计跑步100km

**稀有成就：**
- [ ] "夜跑勇士"：晚上10点后跑步10次
- [ ] "早起鸟"：早上6点前跑步10次
- [ ] "环游世界"：跑步足迹覆盖10个不同城市
- [ ] "探索大师"：打卡50个不同地标

**EventBus事件驱动：**
```swift
// 跑步完成后发送事件
EventBus.shared.post(.runCompleted, data: runData)

// 成就系统监听事件
EventBus.shared.on(.runCompleted) { data in
    AchievementManager.shared.checkAchievements(runData: data)
}
```

### 3.3 排行榜系统

**复用代码：** `LeaderboardManager.swift` (700行，100%)

**榜单类型：**
- [ ] 本周里程榜（谁跑得最多）
- [ ] 月度配速榜（谁跑得最快）
- [ ] 累计坚持榜（连续跑步天数）
- [ ] 地标探索榜（打卡地标数量）

**功能：**
- [ ] 实时排名更新
- [ ] 全球/好友/附近3个维度
- [ ] Supabase窗口函数优化查询：`ROW_NUMBER() OVER (ORDER BY distance DESC)`
- [ ] 缓存机制（5分钟刷新）

**阶段测试**：`xcodebuild -quiet` 全流程跑步Demo

---

## 第四阶段：社交功能（第11-13天）

### 4.1 消息推送系统

**复用代码：** `RadioManager.swift` (500行，100%)

**消息类型：**
- [ ] 系统公告（App更新、活动通知）
- [ ] 训练提醒（该跑步了！今日目标未完成）
- [ ] 好友动态（XXX刚完成了10km跑步）
- [ ] 成就解锁通知（恭喜解锁"马拉松勇士"）

**界面：**
- `MessageCenterView.swift`（消息中心）
- `NotificationSettingsView.swift`（通知设置）

### 4.2 跑步社群（公共频道）

**复用代码：** `CommunicationManager.swift` (1200行，100%)

**功能：**
- [ ] 基于位置的公共聊天（附近3km跑友可见）
- [ ] 实时消息推送（Supabase Realtime）
- [ ] 消息历史记录
- [ ] 图片/文字/语音消息

**界面：**
- `PublicChannelView.swift`（公共频道）
- `ChatView.swift`（聊天界面，Realtime订阅）

### 4.3 跑团频道管理

**复用代码：** `ChannelManager.swift` (600行，100%)

**功能：**
- [ ] 创建私人跑团
- [ ] 加入/退出跑团
- [ ] 跑团成员管理
- [ ] 跑团内聊天
- [ ] 跑团活动发布（本周六晨跑约跑）

**界面：**
- `ChannelListView.swift`（频道列表）
- `ChannelDetailView.swift`（频道详情）
- `CreateChannelView.swift`（创建频道）

---

## 第五阶段：个人中心与商业化（第14-16天）

### 5.1 个人主页

**功能：**
- [ ] 用户档案（头像/昵称/签名）
- [ ] 跑步统计（累计里程/时长/次数）
- [ ] 成就展示（已解锁徽章）
- [ ] 装备展示（当前穿戴）
- [ ] 历史记录（所有跑步记录）

**界面：**
- `ProfileView.swift`（个人主页）
- `StatsView.swift`（统计详情）
- `HistoryView.swift`（历史记录）

### 5.2 详细统计分析

**复用代码：** `DetailedStatsView.swift`

**功能：**
- [ ] 周/月/年统计图表
- [ ] 配速趋势分析
- [ ] 里程累计曲线
- [ ] 热力地图（MapKit overlay，跑步区域分布）
- [ ] AI训练建议

### 5.3 多语言支持

**复用代码：** `Localizable.strings` (3种语言)

**语言：**
- [ ] 简体中文
- [ ] 繁体中文
- [ ] English

**实现：**
```swift
Text("start_run")
    .localized()  // 自动根据系统语言显示"开始跑步"或"Start Run"
```

### 5.4 付费订阅系统（商业化核心）

**复用代码：** `StoreKitManager.swift` (900行，100%)

**订阅方案：**

| 方案 | 价格 | 功能 |
|-----|------|------|
| **基础版（免费）** | ¥0 | 基础跑步追踪、地标打卡（每日3次）、公共频道（只读） |
| **高级版** | ¥19.9/月 | 无限地标打卡、AI实时语音指导、高级数据分析、公共频道发言、去广告 |
| **专业版** | ¥39.9/月 | 高级版所有功能、专属教练1对1指导、定制训练计划、数据导出、家庭共享（最多5人） |

**一次性购买（装备包）：**
- 初级装备包 ¥6（3件普通装备）
- 高级装备包 ¥18（1件稀有装备）
- 传说装备包 ¥68（1件传说装备）

**StoreKit 2实现：**
```swift
@MainActor
func purchase(product: Product) async throws {
    let result = try await product.purchase()

    switch result {
    case .success(let verification):
        unlockPremiumFeatures()  // RevenueCat同步
    case .userCancelled:
        break
    case .pending:
        break
    }
}
```

---

## 第六阶段：高级功能 + AI核心（第17-18天）

### 6.1 训练计划 & AI语音教练（新增核心）

**新模块**：`AIManager.swift` (~200行)
**复用**：`SpeechManager`、`BuildingManager.swift` (1000行，80%)

**训练计划功能：**
- [ ] 预设训练计划（5km入门、10km进阶、半马/全马）
- [ ] 每日训练任务
- [ ] 完成任务解锁高级计划
- [ ] 训练进度追踪

**计划模板：**
```swift
struct TrainingPlan {
    var id: UUID
    var name: String       // "5km入门计划"
    var duration: Int      // 8周
    var difficulty: Level  // 入门/进阶/高级
    var requirements: [Achievement]  // 需要解锁的成就
    var dailyTasks: [Task] // 每日任务
}
```

**AI实现：**
```swift
class AIManager {
    func generatePlan(goal: String, history: [Run]) async -> TrainingPlan {
        let prompt = L("ai_plan_prompt") + "目标: \(goal)"
        // OpenAI/Claude API → JSON解析
    }

    func coachFeedback(pace: Double, hr: Int) async -> String {
        // 延迟<2s，AirPods兼容
    }
}
```

**RunCoordinator**：跑步中定时调用 feedback → Speech播报

### 6.2 交易系统（装备/徽章交换）

**复用代码：** `TradeManager.swift` (800行，95%)

**功能：**
- [ ] 发布交易挂单（用A装备换B装备）
- [ ] 附近跑友可见（100米范围内）
- [ ] 确认交易
- [ ] 交易记录

### 6.3 健康体征监测（类似"生存体征"）

**复用代码：** `VitalSignsManager.swift` (1100行，85%)

**监测指标：**
- [ ] 心率（通过Apple Watch或HealthKit）
- [ ] 卡路里消耗
- [ ] 水分补给提醒（每30分钟提醒喝水）
- [ ] 疲劳度评估

**时间衰减机制：**
- 跑步后疲劳度+20%
- 每小时自动恢复-5%
- 疲劳度>80%时提醒休息
- 疲劳度<30%时鼓励运动

**全面测试**：TestFlight + TelemetryDeck，覆盖离线/后台

---

## 代码文件结构

```
AIRunningCoach/
├── App/
│   ├── AIRunningCoachApp.swift
│   └── RunningTheme.swift          // 跑步色系（蓝绿主调）
│
├── Core/
│   ├── Managers/
│   │   ├── AuthManager.swift       ✓ (100%)
│   │   ├── SupabaseClient.swift    ✓ (100%)
│   │   ├── LocationManager.swift   ✓ (70%，GPS增强)
│   │   ├── AIManager.swift         新增：AI核心
│   │   ├── POIManager.swift        ✓ (100%)
│   │   ├── ItemManager.swift       ✓ (90%)
│   │   ├── AchievementManager.swift ✓ (100%)
│   │   ├── LeaderboardManager.swift ✓ (100%)
│   │   ├── CommunicationManager.swift ✓ (100%)
│   │   ├── ChannelManager.swift    ✓ (100%)
│   │   ├── TradeManager.swift      ✓ (95%)
│   │   ├── StoreKitManager.swift   ✓ (100%)
│   │   ├── VitalSignsManager.swift ✓ (85%)
│   │   └── RadioManager.swift      ✓ (100%)
│   │
│   ├── Coordinators/               新增：统一导航
│   │   ├── AuthCoordinator.swift
│   │   ├── RunCoordinator.swift
│   │   └── MainCoordinator.swift
│   │
│   ├── Models/
│   │   ├── User.swift
│   │   ├── Run.swift
│   │   ├── Route.swift
│   │   ├── Item.swift
│   │   ├── Achievement.swift
│   │   ├── Message.swift
│   │   └── Subscription.swift
│   │
│   └── Utilities/
│       ├── EventBus.swift          ✓ (100%)
│       ├── L.swift                 本地化宏
│       ├── Constants.swift
│       └── Extensions.swift
│
├── Features/
│   ├── Auth/
│   │   ├── LoginView.swift
│   │   ├── RegisterView.swift
│   │   └── ForgotPasswordView.swift
│   │
│   ├── Home/
│   │   └── HomeView.swift          ✓
│   │
│   ├── Run/
│   │   ├── ActiveRunView.swift     ✓ (P0核心)
│   │   ├── RunSummaryView.swift    ✓
│   │   └── POIDiscoveryView.swift
│   │
│   ├── Inventory/
│   │   ├── BackpackView.swift
│   │   └── ItemDetailView.swift
│   │
│   ├── Achievements/
│   │   ├── AchievementsView.swift
│   │   └── AchievementDetailView.swift
│   │
│   ├── Leaderboard/
│   │   └── LeaderboardView.swift
│   │
│   ├── Social/
│   │   ├── MessageCenterView.swift
│   │   ├── PublicChannelView.swift
│   │   ├── ChannelListView.swift
│   │   └── ChatView.swift
│   │
│   ├── Profile/
│   │   ├── ProfileView.swift
│   │   ├── StatsView.swift
│   │   ├── HistoryView.swift       ✓
│   │   └── SettingsView.swift      ✓
│   │
│   └── Store/
│       ├── SubscriptionView.swift
│       └── ItemStoreView.swift
│
├── Resources/
│   ├── Localizable.strings（简中）
│   ├── Localizable.strings（繁中）
│   ├── Localizable.strings（English）
│   └── Assets.xcassets
│
└── Tests/                          单元测试集
```

---

## 功能复用对照表

| 地球新主文件 | 复用到AI跑步教练 | 复用度 | 备注 |
|------------|----------------|-------|------|
| AuthManager.swift | 登录注册 | 100% | ✓ |
| LocationManager.swift | GPS轨迹 | 70% | didUpdate优化 |
| POIManager.swift | POI打卡 | 100% | ✓ |
| ItemManager.swift | 装备系统 | 90% | 加成属性 |
| BuildingManager.swift | 训练计划 | 80% | AIManager封装 |
| TradeManager.swift | 交易系统 | 95% | 附近可见 |
| CommunicationManager.swift | 聊天系统 | 100% | ✓ |
| ChannelManager.swift | 频道管理 | 100% | ✓ |
| AchievementManager.swift | 成就系统 | 100% | EventBus |
| LeaderboardManager.swift | 排行榜 | 100% | ✓ |
| StoreKitManager.swift | 订阅支付 | 100% | StoreKit2 |
| VitalSignsManager.swift | 健康监测 | 85% | 心率疲劳 |
| RadioManager.swift | 消息推送 | 100% | ✓ |
| EventBus.swift | 事件总线 | 100% | ✓ |
| **AIManager.swift** | **新增** | - | AI语音/计划 |

---

## 开发时间线（18天冲刺）

| 阶段 | 天数 | 内容 | 关键测试 |
|-----|------|------|---------|
| **Week1** | 1-3天 | 基础架构：Supabase + 用户认证 | xcodebuild test |
| | 4-6天 | 核心跑步：GPS增强 + POI发现 | GPS精度<10m |
| **Week2** | 7-10天 | 游戏化：装备+成就+排行榜 | EventBus全事件 |
| | 11-13天 | 社交：消息+频道+跑团 | Realtime订阅 |
| **Week3** | 14-16天 | 商业化：个人中心+订阅系统 | StoreKit购买流程 |
| | 17-18天 | 高级功能：AI教练+健康监测 | AI延迟<2s |

**每日仪式**：Claude Code生成代码 → `xcodebuild -quiet` 构建 → Commit

---

## 商业变现模式

### 收入来源1：订阅会员
- 免费版转化率预估：5%
- 月订阅价格：¥19.9
- 1000个用户 → 50个付费 → 月收入¥995

### 收入来源2：装备商城
- 装备包价格：¥6-68
- 预估10%用户购买
- 1000个用户 → 100笔购买 → 月收入¥1000-3000

### 收入来源3：广告（免费版）
- 展示频率：每5分钟1次
- CPM（千次展示收入）：¥10-30
- 1000日活用户 → 月收入¥300-900

**收入预估：**
- 1000用户月收入：¥2,295-4,895
- 10000用户月收入：¥22,950-48,950

---

## 技术优势总结

1. **95%复用**：零从头开发，课程验证过的代码
2. **AIManager**：AI功能零门槛接入
3. **EventBus + Coordinator**：模块解耦，扩展性强
4. **PostGIS + MapKit**：LBS功能免费王牌
5. **StoreKit 2**：苹果官方支付，安全可靠
6. **多语言支持**：一键出海全球市场

---

## 启动行动

1. Fork《地球新主》，改Scheme为AIRunningCoach
2. Day1建Supabase，跑SQL创建表结构
3. 按阶段逐步实现，每日构建验证

**目标：18天拿下MVP，冲App Store！**
