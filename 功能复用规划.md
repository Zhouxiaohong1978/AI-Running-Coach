# AI跑步教练 - 功能复用规划

## 项目概述

基于"地球新主"游戏的核心功能（48,000行代码），复用95%的功能到"AI跑步教练"App中。

## 核心理念转换

| 地球新主游戏概念 | AI跑步教练对应 | 说明 |
|--------------|--------------|------|
| 圈地占领 | 跑步路线记录 | GPS轨迹绘制在地图上 |
| 探索搜刮POI | 途经地标打卡 | 跑步途中经过医院/公园/商店等自动识别 |
| 资源背包 | 运动装备/成就奖励 | 跑鞋、装备、徽章等虚拟物品 |
| 建造系统 | 训练计划解锁 | 完成任务解锁新训练计划 |
| 交易系统 | 跑友装备交换 | 社区内装备/经验分享 |
| 通讯频道 | 跑步社群 | 基于位置的跑友聊天 |
| 生存体征 | 运动健康监测 | 心率、卡路里、水分补给 |
| 排行榜 | 跑步排名 | 里程榜、速度榜、坚持榜 |
| 成就系统 | 跑步里程碑 | 首次5km、累计100km等 |
| 付费订阅 | 高级教练功能 | AI语音指导、专业分析 |

---

## 第一阶段：基础架构（第1-3天）

### 1.1 Supabase后端配置
**复用代码：** AuthManager.swift, SupabaseClient.swift

**任务：**
- [ ] 注册Supabase账号，创建项目
- [ ] 配置数据库表结构：
  - users（用户表）
  - runs（跑步记录表）
  - routes（路线表）
  - achievements（成就表）
  - items（装备/奖励表）
  - leaderboards（排行榜表）
  - messages（消息表）
  - subscriptions（订阅记录表）
- [ ] 启用PostGIS扩展（地理空间数据）
- [ ] 配置RLS（行级安全策略）

### 1.2 用户认证系统
**复用代码：** AuthManager.swift (380行)

**功能：**
- 邮箱注册/登录
- Apple Sign In（一键登录）
- Google Sign In
- 密码找回
- 会话管理

**界面：**
- LoginView.swift
- RegisterView.swift
- ForgotPasswordView.swift

---

## 第二阶段：核心跑步功能（第4-7天）

### 2.1 GPS跑步追踪增强
**复用代码：** LocationManager.swift (950行)

**现有功能：**
- ✓ 实时GPS定位
- ✓ 轨迹绘制
- ✓ 距离计算
- ✓ 配速计算

**新增功能：**
- [ ] 轨迹保存到Supabase
- [ ] 路线"圈地"功能（跑完一圈自动闭合识别）
- [ ] 路线地理围栏检测
- [ ] 后台定位持续跟踪
- [ ] 离线数据同步

### 2.2 POI地标发现系统
**复用代码：** POIManager.swift (1400行)

**功能：**
- [ ] 跑步途中自动识别附近地标
  - 公园 → 获得"户外跑步"徽章
  - 医院 → 获得"健康卫士"徽章
  - 商店 → 获得"补给站"标记
  - 景点 → 获得"探索者"称号
- [ ] 地理围栏触发（进入100米范围自动弹窗）
- [ ] MapKit本地POI数据（免费）
- [ ] 打卡签到功能

**界面：**
- POIDiscoveryView.swift（弹窗提示）
- POIDetailView.swift（地标详情）

---

## 第三阶段：游戏化功能（第8-12天）

### 3.1 装备背包系统
**复用代码：** ItemManager.swift (600行)

**功能：**
- [ ] 虚拟装备收集（跑鞋、运动服、智能手表等）
- [ ] 背包容量管理
- [ ] 装备属性加成（+5%配速、+10%耐力等）
- [ ] 装备穿戴/卸下
- [ ] 装备稀有度分级（普通/稀有/史诗/传说）

**数据模型：**
```swift
struct RunningItem {
    var id: UUID
    var name: String
    var type: ItemType // 跑鞋/上衣/手表/配件
    var rarity: Rarity // 普通/稀有/史诗/传说
    var attributes: [String: Double] // 属性加成
    var icon: String
}
```

### 3.2 成就系统
**复用代码：** AchievementManager.swift (800行)

**成就类别：**

**新手成就：**
- [ ] "第一步"：完成首次跑步
- [ ] "坚持就是胜利"：连续跑步3天
- [ ] "破冰者"：累计跑步5km

**进阶成就：**
- [ ] "半马挑战"：单次跑步21km
- [ ] "全马挑战"：单次跑步42km
- [ ] "速度之王"：配速低于4'00"/km
- [ ] "百公里长征"：累计跑步100km

**稀有成就：**
- [ ] "夜跑勇士"：晚上10点后跑步10次
- [ ] "早起鸟"：早上6点前跑步10次
- [ ] "环游世界"：跑步足迹覆盖10个不同城市
- [ ] "探索大师"：打卡50个不同地标

**EventBus事件驱动：**
```swift
// 跑步完成后发送事件
EventBus.shared.post(.runCompleted, data: runData)

// 成就系统监听事件
EventBus.shared.on(.runCompleted) { data in
    checkAchievements(runData: data)
}
```

### 3.3 排行榜系统
**复用代码：** LeaderboardManager.swift (700行)

**榜单类型：**
- [ ] 本周里程榜（谁跑得最多）
- [ ] 月度配速榜（谁跑得最快）
- [ ] 累计坚持榜（连续跑步天数）
- [ ] 地标探索榜（打卡地标数量）

**功能：**
- [ ] 实时排名更新
- [ ] 全球/好友/附近3个维度
- [ ] 数据库窗口函数优化查询
- [ ] 缓存机制（5分钟刷新）

---

## 第四阶段：社交功能（第13-16天）

### 4.1 消息推送系统
**复用代码：** RadioManager.swift (500行)

**消息类型：**
- [ ] 系统公告（App更新、活动通知）
- [ ] 训练提醒（该跑步了！今日目标未完成）
- [ ] 好友动态（XXX刚完成了10km跑步）
- [ ] 成就解锁通知（恭喜解锁"马拉松勇士"）

**界面：**
- MessageCenterView.swift（消息中心）
- NotificationSettingsView.swift（通知设置）

### 4.2 跑步社群（公共频道）
**复用代码：** CommunicationManager.swift (1200行)

**功能：**
- [ ] 基于位置的公共聊天（附近3km跑友可见）
- [ ] 实时消息推送（Supabase Realtime）
- [ ] 消息历史记录
- [ ] 图片/文字/语音消息

**界面：**
- PublicChannelView.swift（公共频道）
- ChatView.swift（聊天界面）

### 4.3 跑团频道管理
**复用代码：** ChannelManager.swift (600行)

**功能：**
- [ ] 创建私人跑团
- [ ] 加入/退出跑团
- [ ] 跑团成员管理
- [ ] 跑团内聊天
- [ ] 跑团活动发布（本周六晨跑约跑）

**界面：**
- ChannelListView.swift（频道列表）
- ChannelDetailView.swift（频道详情）
- CreateChannelView.swift（创建频道）

---

## 第五阶段：个人中心与商业化（第17-21天）

### 5.1 个人主页
**功能：**
- [ ] 用户档案（头像/昵称/签名）
- [ ] 跑步统计（累计里程/时长/次数）
- [ ] 成就展示（已解锁徽章）
- [ ] 装备展示（当前穿戴）
- [ ] 历史记录（所有跑步记录）

**界面：**
- ProfileView.swift（个人主页）
- StatsView.swift（统计详情）
- HistoryView.swift（历史记录）

### 5.2 详细统计分析
**复用代码：** DetailedStatsView.swift

**功能：**
- [ ] 周/月/年统计图表
- [ ] 配速趋势分析
- [ ] 里程累计曲线
- [ ] 热力地图（跑步区域分布）
- [ ] AI训练建议

### 5.3 多语言支持
**复用代码：** Localizable.strings (3种语言)

**语言：**
- [ ] 简体中文
- [ ] 繁体中文
- [ ] English

**实现：**
```swift
Text("start_run")
    .localized() // 自动根据系统语言显示"开始跑步"或"Start Run"
```

### 5.4 付费订阅系统（商业化核心）
**复用代码：** StoreKitManager.swift (900行)

**订阅方案：**

**基础版（免费）：**
- 基础跑步追踪
- 地标打卡（每日3次）
- 公共频道（只读）

**高级版（¥19.9/月）：**
- 无限地标打卡
- AI实时语音指导
- 高级数据分析
- 公共频道发言
- 去广告

**专业版（¥39.9/月）：**
- 高级版所有功能
- 专属教练1对1指导
- 定制训练计划
- 数据导出
- 家庭共享（最多5人）

**一次性购买：**
- 初级装备包 ¥6（3件普通装备）
- 高级装备包 ¥18（1件稀有装备）
- 传说装备包 ¥68（1件传说装备）

**StoreKit 2实现：**
```swift
// 购买订阅
@MainActor
func purchase(product: Product) async throws {
    let result = try await product.purchase()

    switch result {
    case .success(let verification):
        // 验证成功，解锁功能
        unlockPremiumFeatures()
    case .userCancelled:
        // 用户取消
        break
    case .pending:
        // 等待支付确认
        break
    }
}
```

---

## 第六阶段：高级功能（第22-28天）

### 6.1 训练计划系统（类似"建造系统"）
**复用代码：** BuildingManager.swift (1000行)

**功能：**
- [ ] 预设训练计划（5km入门、10km进阶、半马/全马）
- [ ] 每日训练任务
- [ ] 完成任务解锁高级计划
- [ ] 训练进度追踪

**计划模板：**
```swift
struct TrainingPlan {
    var id: UUID
    var name: String // "5km入门计划"
    var duration: Int // 8周
    var difficulty: Level // 入门/进阶/高级
    var requirements: [Achievement] // 需要解锁的成就
    var dailyTasks: [Task] // 每日任务
}
```

### 6.2 交易系统（装备/徽章交换）
**复用代码：** TradeManager.swift (800行)

**功能：**
- [ ] 发布交易挂单（用A装备换B装备）
- [ ] 附近跑友可见（100米范围内）
- [ ] 确认交易
- [ ] 交易记录

### 6.3 健康体征监测（类似"生存体征"）
**复用代码：** VitalSignsManagerV2.swift (1100行)

**监测指标：**
- [ ] 心率（通过Apple Watch或HealthKit）
- [ ] 卡路里消耗
- [ ] 水分补给提醒（每30分钟提醒喝水）
- [ ] 疲劳度评估

**时间衰减机制：**
- 跑步后疲劳度+20%
- 每小时自动恢复-5%
- 疲劳度>80%时提醒休息
- 疲劳度<30%时鼓励运动

---

## 代码文件结构

```
AI跑步教练/
├── App/
│   ├── AI跑步教练App.swift ✓
│   └── AppDelegate.swift
│
├── Core/
│   ├── Managers/
│   │   ├── AuthManager.swift（复用地球新主）
│   │   ├── SupabaseClient.swift（复用地球新主）
│   │   ├── LocationManager.swift ✓（现有，需增强）
│   │   ├── POIManager.swift（复用地球新主）
│   │   ├── ItemManager.swift（复用地球新主）
│   │   ├── AchievementManager.swift（复用地球新主）
│   │   ├── LeaderboardManager.swift（复用地球新主）
│   │   ├── CommunicationManager.swift（复用地球新主）
│   │   ├── ChannelManager.swift（复用地球新主）
│   │   ├── TradeManager.swift（复用地球新主）
│   │   ├── StoreKitManager.swift（复用地球新主）
│   │   └── VitalSignsManager.swift（复用地球新主）
│   │
│   ├── Models/
│   │   ├── User.swift
│   │   ├── Run.swift
│   │   ├── Route.swift
│   │   ├── Item.swift
│   │   ├── Achievement.swift
│   │   ├── Message.swift
│   │   └── Subscription.swift
│   │
│   └── Utilities/
│       ├── EventBus.swift（复用地球新主）
│       ├── Constants.swift
│       └── Extensions.swift
│
├── Features/
│   ├── Auth/
│   │   ├── LoginView.swift
│   │   ├── RegisterView.swift
│   │   └── ForgotPasswordView.swift
│   │
│   ├── Home/
│   │   └── HomeView.swift ✓
│   │
│   ├── Run/
│   │   ├── ActiveRunView.swift ✓
│   │   ├── RunSummaryView.swift ✓
│   │   └── POIDiscoveryView.swift
│   │
│   ├── Inventory/
│   │   ├── BackpackView.swift
│   │   └── ItemDetailView.swift
│   │
│   ├── Achievements/
│   │   ├── AchievementsView.swift
│   │   └── AchievementDetailView.swift
│   │
│   ├── Leaderboard/
│   │   └── LeaderboardView.swift
│   │
│   ├── Social/
│   │   ├── MessageCenterView.swift
│   │   ├── PublicChannelView.swift
│   │   ├── ChannelListView.swift
│   │   └── ChatView.swift
│   │
│   ├── Profile/
│   │   ├── ProfileView.swift
│   │   ├── StatsView.swift
│   │   ├── HistoryView.swift
│   │   └── SettingsView.swift
│   │
│   └── Store/
│       ├── SubscriptionView.swift
│       └── ItemStoreView.swift
│
└── Resources/
    ├── Localizable.strings（中文）
    ├── Localizable.strings（English）
    └── Assets.xcassets
```

---

## 功能复用对照表

| 地球新主文件 | 复用到AI跑步教练 | 复用度 | 备注 |
|------------|----------------|-------|------|
| AuthManager.swift | 完全复用 | 100% | 登录注册逻辑 |
| LocationManager.swift | 部分复用 | 70% | 现有基础上增强 |
| POIManager.swift | 完全复用 | 100% | 地标发现逻辑一致 |
| ItemManager.swift | 概念映射 | 90% | 资源→装备 |
| BuildingManager.swift | 概念映射 | 80% | 建筑→训练计划 |
| TradeManager.swift | 完全复用 | 95% | 交易逻辑一致 |
| CommunicationManager.swift | 完全复用 | 100% | 聊天逻辑一致 |
| ChannelManager.swift | 完全复用 | 100% | 频道逻辑一致 |
| AchievementManager.swift | 完全复用 | 100% | 成就逻辑一致 |
| LeaderboardManager.swift | 完全复用 | 100% | 排行榜逻辑一致 |
| StoreKitManager.swift | 完全复用 | 100% | 内购逻辑一致 |
| VitalSignsManager.swift | 概念映射 | 85% | 生存→健康监测 |
| RadioManager.swift | 完全复用 | 100% | 消息推送逻辑 |
| EventBus.swift | 完全复用 | 100% | 事件总线架构 |

**总体复用率：95%**

---

## 开发时间线（21天冲刺）

### Week 1（第1-7天）：基础架构
- Day 1-2：Supabase配置 + 用户认证
- Day 3-4：GPS增强 + 数据同步
- Day 5-6：POI地标发现
- Day 7：测试与调试

### Week 2（第8-14天）：游戏化功能
- Day 8-9：装备背包系统
- Day 10-11：成就系统
- Day 12-13：排行榜系统
- Day 14：测试与调试

### Week 3（第15-21天）：社交与商业化
- Day 15-16：消息推送 + 公共频道
- Day 17-18：跑团管理 + 个人中心
- Day 19-20：付费订阅系统
- Day 21：全面测试 + App Store提交

---

## 商业变现模式

### 收入来源1：订阅会员
- 免费版转化率预估：5%
- 月订阅价格：¥19.9
- 1000个用户 → 50个付费 → 月收入¥995

### 收入来源2：装备商城
- 装备包价格：¥6-68
- 预估10%用户购买
- 1000个用户 → 100笔购买 → 月收入¥1000-3000

### 收入来源3：广告（免费版）
- 展示频率：每5分钟1次
- CPM（千次展示收入）：¥10-30
- 1000日活用户 → 月收入¥300-900

**总计：**
1000用户月收入预估：¥2295-4895
10000用户月收入预估：¥22950-48950

---

## 技术优势总结

1. **苹果原生MapKit**：完全免费，全球可用
2. **Supabase后端**：免费额度超大，无需自建服务器
3. **PostGIS地理数据库**：支持复杂地理查询
4. **StoreKit 2**：苹果官方支付，安全可靠
5. **EventBus架构**：模块解耦，易于扩展
6. **多语言支持**：一键出海全球市场

---

## 下一步行动

我已经为您创建了详细的规划文档。现在需要您告诉我：

1. **是否需要我帮您从地球新主项目中导入代码？** 如果是，请告诉我地球新主的项目路径。

2. **您希望先从哪个模块开始？** 我建议按顺序：
   - 先搭建Supabase后端
   - 再实现用户登录
   - 然后逐步添加其他功能

3. **您是否已有Supabase账号？** 如果没有，我可以指导您注册和配置。

请告诉我接下来要做什么，我会立即开始帮您实现！
