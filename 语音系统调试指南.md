# 语音系统调试指南 v2

## 🔧 本次修复内容

### 1. 停止按钮修复 ✅
- 停止时同时停止定时器、语音播放、重置状态
- 距离 >= 3km 时自动触发完成庆祝语音
- 添加完整的状态清理逻辑

### 2. 触发匹配优化 ✅
- **修复距离触发**：允许回溯触发（不会因为跳过某个距离点而漏掉语音）
- **按顺序播放**：优先触发 order 最小的脚本
- **状态触发修复**：正确处理开始(0)、行走(1)、完成(2) 状态
- **详细日志**：显示触发条件和当前值

### 3. 完成庆祝语音 ✅
- 新增 `triggerCompletionVoices()` 方法
- 停止跑步时自动触发所有完成相关语音（state=2）
- 语音之间自动间隔 1 秒

### 4. 演示界面改进 ✅
- 添加 +100米、+500米、+1公里 按钮
- 添加"快速到达3公里"按钮（测试完成语音）
- 显示详细调试日志

## 📱 完整测试流程

### 测试 1：新手模式完整流程

1. **启动测试**
   - 进入"设置" → "AI语音教练演示"
   - 选择"新手3公里"模式
   - 点击"开始跑步"
   - **预期**：听到"我们轻轻开始，像饭后散步一样..."

2. **逐步增加距离**
   ```
   点击 +100米 → 听到 "注意感受脚掌落地再弹起的感觉..."
   点击 +100米 → 听到 "前500米是用来让身体'打招呼'的..."
   点击 +300米 → 听到 "500米了！身体开始热起来了..."
   点击 +500米 → 听到 "1公里！第一个里程碑..."
   点击 +1公里 → 听到 "2公里！新手毕业的门槛就在眼前..."
   点击 +1公里 → 听到 "3公里达成！"
   ```

3. **触发完成语音**
   - 点击"停止跑步"
   - **预期**：依次听到 4-5 条完成庆祝语音：
     - "慢慢停下，不要立刻静止..."
     - "恭喜！你刚刚完成了人生第一个3公里..."
     - "看看你的数据：3公里..."
     - "感受一下此刻的身体..."
     - "这个成就属于你..."

### 测试 2：快速测试完成语音

1. 点击"开始跑步"
2. 直接点击"快速到达3公里（测试完成语音）"
3. 等待 5 秒（让定时器触发）
4. 点击"停止跑步"
5. **预期**：听到所有完成庆祝语音

### 测试 3：减肥模式

1. 选择"减肥燃脂"模式
2. 点击"开始跑步"
3. 点击"增加100大卡"
4. **预期**：听到"100大卡达成！相当于1个苹果派..."

## 🔍 Xcode 控制台日志示例

### 正常流程日志：
```
🚀 开始跑步，模式: beginner
⏰ 触发引擎定时器已启动（每 5 秒检查）
📍 距离: 0.1km
✓ 触发条件满足: beginner_02_body_awareness (distance=0.1, 当前:0.1km)
🎯 触发脚本 #2: beginner_02_body_awareness
   内容: 注意感受脚掌落地再弹起的感觉...
📢 准备播放: 注意感受脚掌落地再弹起的感觉，像在弹簧床上轻轻跳。...
🔊 开始 TTS 请求: 注意感受脚掌落地再...
📥 收到响应: 200, 大小: 98765 字节
✅ 音频准备完成，时长: 3.8秒
🎵 开始播放
✅ 播放完成
```

### 完成语音日志：
```
🛑 停止跑步
🎉 触发完成状态
📢 找到 5 条完成语音
🎊 播放完成语音: beginner_21_cooldown
🔊 开始 TTS 请求: 慢慢停下，不要立刻静止...
✅ 播放完成
🎊 播放完成语音: beginner_22_congrats
...
```

## 🐛 故障排查

### 问题 1：停止按钮没反应
**检查**：
- Xcode 控制台是否显示 "🛑 停止跑步"
- 定时器是否停止（不再有检查日志）

**解决**：已修复，stop() 方法现在会停止所有活动

### 问题 2：语音播报内容不匹配
**原因**：触发条件范围太窄，跳过了某些距离点

**解决**：
- 移除距离范围限制，允许回溯触发
- 按 order 排序，优先触发序号小的

### 问题 3：完成语音没有播放
**原因**：state=2 的触发条件未正确实现

**解决**：
- 在 stop() 时设置 `context.isFinished = true`
- 调用 `triggerCompletionVoices()` 依次播放所有完成语音

### 问题 4：语音只播放一两个字就断
**原因**：音频会话配置问题

**解决**：
- 配置 AVAudioSession 为 `.playback` 模式
- 确保 `prepareToPlay()` 完成后再播放
- 在主线程管理播放器

## 📊 脚本触发条件参考

### 新手模式主要里程碑：
```
距离 0km    → "我们轻轻开始..."
距离 0.1km  → "注意感受脚掌落地..."
距离 0.2km  → "前500米是用来让身体'打招呼'的..."
距离 0.5km  → "500米了！身体开始热起来..."
距离 1.0km  → "1公里！第一个里程碑..."
距离 1.5km  → "1.5公里，已经过半了..."
距离 2.0km  → "2公里！新手毕业的门槛..."
距离 2.5km  → "2.5公里！最后500米..."
距离 3.0km  → "3…2…1…完成！"
状态 完成    → 5条庆祝语音
```

### 减肥模式主要里程碑：
```
距离 0km    → "燃脂模式启动！"
热量 100卡  → "100大卡达成！"
热量 200卡  → "200大卡！"
热量 300卡  → "300大卡里程碑！"
心率 150+   → "注意呼吸，脂肪燃烧需要充足的氧气..."
状态 完成    → "跑步结束！但燃脂还在继续..."
```

## ✅ 验收标准

- [ ] 点击"开始跑步"能听到开场语音
- [ ] 增加距离能触发对应的里程碑语音
- [ ] 语音能完整播放（不中断）
- [ ] 停止按钮能立即停止所有活动
- [ ] 达到 3km 后停止，能听到完成庆祝语音
- [ ] 语音之间有合理间隔（不堆积）
- [ ] Xcode 控制台日志清晰完整

---

**更新时间**: 2026-02-01 15:30
**版本**: v2
**状态**: 已修复所有已知问题
