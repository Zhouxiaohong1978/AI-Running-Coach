# 语音冷却机制测试指南

## 📋 实施概览

已成功实施阶段 1-3 的所有修复：

### ✅ 阶段 1：数据模型升级
- [x] 为 `VoiceScript` 添加 `cooldown` 字段（默认值 15 秒）
- [x] 修复 beginner_15 和 beginner_16 的触发冲突（已合并）
- [x] 为所有 50 条语音脚本添加合理的冷却时间

### ✅ 阶段 2：冷却机制实现
- [x] 在 `VoiceService` 中添加全局冷却管理（15 秒）
- [x] 实现 `canSpeakNow()` 冷却检查方法
- [x] 实现 `resetCooldown()` 方法
- [x] 修改 `speak()` 方法支持脚本特定冷却时间

### ✅ 阶段 3：触发逻辑优化
- [x] 添加触发间隔检查（最小 2 秒）
- [x] 实现优先级排序算法 `getPriority()`
- [x] 确保一次只触发最高优先级语音
- [x] 在 `start()` 时重置所有冷却

---

## 🧪 测试方法

### 方法 1：使用 RunningDemoView（推荐）

1. 在 Xcode 中运行项目
2. 进入"AI跑步教练演示"页面
3. 选择"新手3公里"模式
4. 点击"开始跑步"

#### 测试场景 1：验证 2.5km 无冲突
```
1. 点击"开始跑步"
2. 点击"测试2.5km触发（验证无冲突）"
3. 查看控制台输出
```

**预期结果：**
```
✓ 触发条件满足: beginner_15_2_5km
🎯 触发脚本 #15: beginner_15_2_5km (优先级: 50)
   内容: 两点五公里！最后五百米...
📢 准备播放: 两点五公里！最后五百米... (冷却: 15秒)
🔊 开始 TTS 请求: 两点五公里！...
```

**不应该出现：**
- ❌ `beginner_16_final_500m` 任何提及
- ❌ 两条语音同时触发

#### 测试场景 2：验证冷却机制
```
1. 点击"开始跑步"
2. 快速连续点击"+500米"按钮 3 次
3. 观察语音间隔
```

**预期结果：**
- 第一条语音正常播放
- 后续语音被冷却拦截，输出：
  ```
  ⏸️ 语音冷却中（距上次 X秒，需要 15秒），跳过播放
  ```

#### 测试场景 3：验证优先级排序
```
1. 点击"开始跑步"
2. 点击"+1公里"到达 1km
3. 点击"模拟心率升高"（心率 165）
4. 观察哪条语音先触发
```

**预期结果：**
- 如果同时满足多个触发条件，应该优先触发高优先级的
- 里程碑语音（1km）优先级 80
- 心率预警优先级 90（如果心率 >= 170）

#### 测试场景 4：验证冷却重置
```
1. 点击"开始跑步"
2. 点击"+500米"触发语音
3. 点击"停止跑步"
4. 再次点击"开始跑步"
5. 立即点击"+100米"
```

**预期结果：**
- 第二次开始后，冷却已重置，开场语音可以立即播放
- 控制台输出：`🔄 语音冷却已重置`

---

## 📊 冷却时间配置

### 新手模式
| 类型 | 冷却时间 | 示例脚本 |
|------|---------|---------|
| 开场 | 30s | beginner_01_start |
| 里程碑 | 25s | beginner_06_1km, beginner_11_2km |
| 安全预警 | 60s | beginner_07_walk_ok, beginner_26_heart_rate_high |
| 疲劳支持 | 120s | beginner_12_reframe_fatigue |
| 冲刺 | 15s | beginner_17_choice, beginner_18_count_steps |
| 跑后 | 10s | beginner_21_cooldown, beginner_22_congrats |

### 减肥模式
| 类型 | 冷却时间 | 示例脚本 |
|------|---------|---------|
| 开场 | 30s | fatburn_01_start |
| 里程碑 | 25s | fatburn_04_100cal, fatburn_06_200cal |
| 心率区间 | 180s | fatburn_05_hr_zone（避免重复提醒）|
| 安全预警 | 60s | fatburn_07_oxygen |
| 疲劳支持 | 120s | fatburn_11_visualization |
| 跑后 | 10s | fatburn_18_continuing_burn |

---

## 🔍 优先级规则

```swift
完成状态 (state = 2)          → 100  // 最高优先级
高心率预警 (heartRate >= 170) → 90
整公里里程碑                   → 80
整百大卡里程碑                 → 70
时间里程碑 (>= 15分钟)        → 65
普通指导                       → 50   // 默认
```

---

## 🐛 已修复的问题

### 问题 1：触发冲突 ✅
- **原问题：** beginner_15_2_5km 和 beginner_16_final_500m 都在 2.5km 触发
- **修复：** 合并为单条脚本 beginner_15_2_5km
- **验证：** 使用测试场景 1

### 问题 2：语音轰炸 ✅
- **原问题：** 冲刺阶段语音间隔太近，可能连续触发
- **修复：** 添加全局冷却 15 秒 + 脚本特定冷却
- **验证：** 使用测试场景 2

### 问题 3：优先级混乱 ✅
- **原问题：** 多个条件同时满足时，可能触发低优先级语音
- **修复：** 实现 `getPriority()` 优先级排序算法
- **验证：** 使用测试场景 3

### 问题 4：冷却不重置 ✅
- **原问题：** 重新开始跑步时，冷却状态未清空
- **修复：** 在 `start()` 中调用 `resetCooldown()`
- **验证：** 使用测试场景 4

---

## 📝 控制台日志关键词

监控这些日志，验证修复：

✅ **正常日志：**
```
🚀 开始跑步，模式: beginner
🔄 语音冷却已重置
✓ 触发条件满足: beginner_15_2_5km
🎯 触发脚本 #15: beginner_15_2_5km (优先级: 50)
📢 准备播放: ... (冷却: 15秒)
✅ 语音播放成功
```

❌ **异常日志（不应出现）：**
```
❌ beginner_16_final_500m  // 这个脚本已删除
❌ 在 2.5km 处触发的脚本数量: 2  // 应该只有 1
```

⏸️ **冷却拦截日志（正常）：**
```
⏸️ 语音冷却中（距上次 5.2秒，需要 15秒），跳过播放
```

---

## 🚀 下一步：阶段 4（量化条件）

阶段 1-3 完成后，可以继续实施阶段 4：

### 待实施：量化模糊条件
- [ ] 创建 `ConditionQuantifier.swift`
- [ ] 量化 "疲劳=高" 条件（持续时间 > 20分钟 + 配速下降 15%）
- [ ] 量化 "状态不佳" 条件（配速慢 30% + 心率高 20%）
- [ ] 量化 "最佳燃脂区间" 条件（60-70% 最大心率）
- [ ] 修改 `shouldTrigger()` 使用量化条件

---

**更新时间：** 2026-02-01
**状态：** 阶段 1-3 已完成，待测试验证
**下一步：** 运行测试 → 修复发现的问题 → 实施阶段 4
