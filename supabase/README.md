# Supabase Edge Functions éƒ¨ç½²æ–‡æ¡£

## ğŸ“ é¡¹ç›®ç»“æ„

```
supabase/
â”œâ”€â”€ functions/
â”‚   â”œâ”€â”€ _shared/              # å…±äº«ä»£ç 
â”‚   â”‚   â”œâ”€â”€ bailian.ts        # é˜¿é‡Œäº‘ç™¾ç‚¼ API è°ƒç”¨
â”‚   â”‚   â””â”€â”€ openai.ts         # OpenAI API è°ƒç”¨ï¼ˆå¤‡ç”¨ï¼‰
â”‚   â”œâ”€â”€ generate-training-plan/  # è®­ç»ƒè®¡åˆ’ç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ coach-feedback/       # æ•™ç»ƒåé¦ˆ
â”‚   â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ config.toml               # é…ç½®æ–‡ä»¶
â””â”€â”€ README.md                 # æœ¬æ–‡æ¡£
```

## ğŸ”‘ ç¯å¢ƒå˜é‡é…ç½®

åœ¨ Supabase Dashboard ä¸­è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

### å¿…éœ€é…ç½®

**é˜¿é‡Œäº‘ç™¾ç‚¼ API Key**
```bash
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxx
```

**è·å–æ–¹å¼**ï¼š
1. ç™»å½•é˜¿é‡Œäº‘ç™¾ç‚¼æ§åˆ¶å°ï¼šhttps://bailian.console.aliyun.com/
2. è¿›å…¥"API-KEYç®¡ç†"
3. åˆ›å»ºæˆ–æŸ¥çœ‹ API Key

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### 1. å®‰è£… Supabase CLI

```bash
# macOS
brew install supabase/tap/supabase

# æˆ–ä½¿ç”¨ npm
npm install -g supabase
```

### 2. ç™»å½• Supabase

```bash
supabase login
```

### 3. å…³è”é¡¹ç›®

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd /Users/zhouxiaohong/Desktop/AIRunningCoach

# å…³è”åˆ°ä½ çš„ Supabase é¡¹ç›®
supabase link --project-ref <your-project-id>
```

### 4. è®¾ç½®ç¯å¢ƒå˜é‡

```bash
# è®¾ç½®é˜¿é‡Œäº‘ç™¾ç‚¼ API Key
supabase secrets set DASHSCOPE_API_KEY=<your-dashscope-api-key>

# éªŒè¯è®¾ç½®
supabase secrets list
```

### 5. éƒ¨ç½² Edge Functions

```bash
# éƒ¨ç½²æ‰€æœ‰ functions
supabase functions deploy

# æˆ–å•ç‹¬éƒ¨ç½²
supabase functions deploy generate-training-plan
supabase functions deploy coach-feedback
```

### 6. éªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹éƒ¨ç½²çš„ functions
supabase functions list
```

## ğŸ§ª æµ‹è¯• Edge Functions

### æ–¹æ³• 1: ä½¿ç”¨ curl æµ‹è¯•

#### æµ‹è¯•è®­ç»ƒè®¡åˆ’ç”Ÿæˆ

```bash
curl -i --location --request POST \
  'https://<your-project-ref>.supabase.co/functions/v1/generate-training-plan' \
  --header 'Authorization: Bearer <your-anon-key>' \
  --header 'Content-Type: application/json' \
  --data '{
    "goal": "5kmå…¥é—¨",
    "avgPace": 6.5,
    "maxDistance": 3.0,
    "weeklyRuns": 3,
    "durationWeeks": 8
  }'
```

#### æµ‹è¯•æ•™ç»ƒåé¦ˆ

```bash
curl -i --location --request POST \
  'https://<your-project-ref>.supabase.co/functions/v1/coach-feedback' \
  --header 'Authorization: Bearer <your-anon-key>' \
  --header 'Content-Type: application/json' \
  --data '{
    "currentPace": 6.5,
    "distance": 2.5,
    "duration": 900,
    "coachStyle": "encouraging"
  }'
```

### æ–¹æ³• 2: åœ¨ iOS åº”ç”¨ä¸­æµ‹è¯•

ç›´æ¥è¿è¡Œ Appï¼Œä½¿ç”¨å·²ç»é›†æˆå¥½çš„åŠŸèƒ½ï¼š

**æµ‹è¯•è®­ç»ƒè®¡åˆ’ç”Ÿæˆ**ï¼š
1. æ‰“å¼€ App
2. ç‚¹å‡»åº•éƒ¨ Tab "è®¡åˆ’"
3. ç‚¹å‡»"åˆ›å»ºè®­ç»ƒè®¡åˆ’"
4. é€‰æ‹©ç›®æ ‡ï¼ˆå¦‚"5kmå…¥é—¨"ï¼‰
5. ç‚¹å‡»"ç”Ÿæˆè®­ç»ƒè®¡åˆ’"

**æµ‹è¯•æ•™ç»ƒåé¦ˆ**ï¼š
1. ç‚¹å‡»"å¼€å§‹è·‘æ­¥"
2. è·‘æ­¥æ»¡1å…¬é‡Œåï¼ŒAI ä¼šè‡ªåŠ¨æ’­æŠ¥åé¦ˆ
3. æˆ–è€…æ¯5åˆ†é’Ÿä¼šè‡ªåŠ¨è§¦å‘ä¸€æ¬¡åé¦ˆ

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### âœ… è®­ç»ƒè®¡åˆ’ç”ŸæˆåŠŸèƒ½

**æµ‹è¯•æ­¥éª¤**ï¼š
1. åœ¨ App ä¸­è¿›å…¥"è®¡åˆ’" Tab
2. ç‚¹å‡»"åˆ›å»ºè®­ç»ƒè®¡åˆ’"
3. é€‰æ‹©ä»»æ„ç›®æ ‡ï¼ˆå¦‚"3kmæ–°æ‰‹"ï¼‰
4. è°ƒæ•´å‘¨æœŸï¼ˆé»˜è®¤6å‘¨ï¼‰
5. ç‚¹å‡»"ç”Ÿæˆè®­ç»ƒè®¡åˆ’"

**éªŒæ”¶é€šè¿‡æ ‡å‡†**ï¼š
- [ ] æ˜¾ç¤º"AIæ­£åœ¨ç”Ÿæˆè®­ç»ƒè®¡åˆ’..."åŠ è½½åŠ¨ç”»
- [ ] 10ç§’å†…è¿”å›ç»“æœ
- [ ] æ˜¾ç¤ºå®Œæ•´çš„è®­ç»ƒè®¡åˆ’ï¼ŒåŒ…å«ï¼š
  - [ ] ç›®æ ‡åç§°ï¼ˆå¦‚"3kmæ–°æ‰‹"ï¼‰
  - [ ] å‘¨æ•°ï¼ˆå¦‚"6å‘¨"ï¼‰
  - [ ] éš¾åº¦æ ‡ç­¾ï¼ˆå…¥é—¨/è¿›é˜¶/é«˜çº§ï¼‰
  - [ ] æ¯å‘¨çš„è®­ç»ƒä»»åŠ¡ï¼ˆè‡³å°‘3ä¸ªï¼‰
  - [ ] è®­ç»ƒå»ºè®®ï¼ˆè‡³å°‘3æ¡ï¼‰
- [ ] å¯ä»¥åˆ‡æ¢è§†å›¾æ¨¡å¼ï¼ˆå‘¨è§†å›¾/æœˆå†/æœˆæ¦‚è§ˆï¼‰
- [ ] è®­ç»ƒè®¡åˆ’ä¿å­˜åˆ°æœ¬åœ°ï¼Œä¸‹æ¬¡æ‰“å¼€ä»å¯æŸ¥çœ‹

**å¤±è´¥å¤„ç†**ï¼š
- [ ] ç½‘ç»œé”™è¯¯æ—¶æ˜¾ç¤ºå‹å¥½æç¤º
- [ ] API å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- [ ] å¯ä»¥é‡æ–°ç”Ÿæˆ

### âœ… AI æ•™ç»ƒåé¦ˆåŠŸèƒ½

**æµ‹è¯•æ­¥éª¤**ï¼š
1. ç‚¹å‡»"å¼€å§‹è·‘æ­¥"
2. ç¡®ä¿è¯­éŸ³å¼€å…³ï¼ˆéº¦å…‹é£å›¾æ ‡ï¼‰æ˜¯æ‰“å¼€çŠ¶æ€
3. æ¨¡æ‹Ÿè·‘æ­¥ï¼ˆåœ¨æ¨¡æ‹Ÿå™¨ä¸­ä½¿ç”¨"Simulate Location"ï¼‰
4. è·‘æ»¡1å…¬é‡Œ

**éªŒæ”¶é€šè¿‡æ ‡å‡†**ï¼š
- [ ] æ¯å…¬é‡Œè‡ªåŠ¨æ’­æŠ¥è·ç¦»ï¼ˆ"å·²è·‘1å…¬é‡Œ"ï¼‰
- [ ] éšåæ’­æŠ¥ AI æ•™ç»ƒåé¦ˆï¼ˆ15-25å­—ï¼‰
- [ ] å±å¹•é¡¶éƒ¨æ˜¾ç¤ºåé¦ˆæ°”æ³¡ï¼ˆ3ç§’åæ¶ˆå¤±ï¼‰
- [ ] è¯­éŸ³æ’­æŠ¥æµç•…ï¼Œæ— å¡é¡¿
- [ ] åé¦ˆå†…å®¹æœ‰æ„ä¹‰ï¼ˆä¸æ˜¯ä¹±ç æˆ–é”™è¯¯ä¿¡æ¯ï¼‰
- [ ] æ¯5åˆ†é’Ÿä¼šå†æ¬¡è§¦å‘åé¦ˆ

**æ•™ç»ƒé£æ ¼éªŒè¯**ï¼š
- [ ] é¼“åŠ±å‹ï¼šè¯­æ°”ç§¯æã€çƒ­æƒ…ï¼ˆ"å¤ªæ£’äº†ï¼ç»§ç»­åŠ æ²¹ï¼"ï¼‰
- [ ] ä¸¥æ ¼å‹ï¼šè¯­æ°”ä¸“ä¸šã€ç›´æ¥ï¼ˆ"é…é€Ÿåå¿«ï¼Œæ³¨æ„æ§åˆ¶"ï¼‰
- [ ] æ¸©å’Œå‹ï¼šè¯­æ°”å¹³å’Œã€å‹å¥½ï¼ˆ"æ…¢æ…¢æ¥ï¼Œä½ åšå¾—å¾ˆå¥½"ï¼‰

**å¤±è´¥å¤„ç†**ï¼š
- [ ] API å¤±è´¥æ—¶ä½¿ç”¨åå¤‡åé¦ˆï¼ˆ8æ¡é¢„å®šä¹‰æ¶ˆæ¯ï¼‰
- [ ] ä¸ä¼šå› ä¸º AI å¤±è´¥è€Œä¸­æ–­è·‘æ­¥
- [ ] è¯­éŸ³å¼€å…³å…³é—­æ—¶ä¸æ’­æŠ¥

## ğŸ› å¸¸è§é—®é¢˜

### 1. éƒ¨ç½²å¤±è´¥ï¼š"DASHSCOPE_API_KEY not configured"

**è§£å†³**ï¼š
```bash
# ç¡®è®¤ç¯å¢ƒå˜é‡å·²è®¾ç½®
supabase secrets list

# å¦‚æœæ²¡æœ‰ï¼Œé‡æ–°è®¾ç½®
supabase secrets set DASHSCOPE_API_KEY=<your-key>
```

### 2. iOS è°ƒç”¨å¤±è´¥ï¼š"Network Error"

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] Supabase URL é…ç½®æ­£ç¡®ï¼ˆ`AuthManager.swift` ä¸­ï¼‰
- [ ] Supabase Anon Key é…ç½®æ­£ç¡®
- [ ] Edge Functions å·²æˆåŠŸéƒ¨ç½²
- [ ] ç¯å¢ƒå˜é‡å·²è®¾ç½®

### 3. AI è¿”å›ç»“æœæ ¼å¼é”™è¯¯

**æ’æŸ¥**ï¼š
```bash
# æŸ¥çœ‹ function æ—¥å¿—
supabase functions logs generate-training-plan
supabase functions logs coach-feedback
```

åå¤‡æ–¹æ¡ˆå·²å†…ç½®ï¼š
- è®­ç»ƒè®¡åˆ’ï¼šä¼šè¿”å›ç®€å•çš„æ¸è¿›å¼è®¡åˆ’
- æ•™ç»ƒåé¦ˆï¼šä¼šä»8æ¡é¢„å®šä¹‰æ¶ˆæ¯ä¸­éšæœºé€‰æ‹©

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### æŸ¥çœ‹ Function æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
supabase functions logs generate-training-plan --tail

# æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
supabase functions logs coach-feedback --limit 50
```

### æ€§èƒ½æŒ‡æ ‡

- **è®­ç»ƒè®¡åˆ’ç”Ÿæˆ**ï¼šç›®æ ‡ < 10ç§’
- **æ•™ç»ƒåé¦ˆ**ï¼šç›®æ ‡ < 3ç§’
- **æˆåŠŸç‡**ï¼šç›®æ ‡ > 95%ï¼ˆå¤±è´¥æ—¶ä½¿ç”¨åå¤‡æ–¹æ¡ˆï¼‰

## ğŸ”„ æ›´æ–° Edge Functions

ä¿®æ”¹ä»£ç åï¼Œé‡æ–°éƒ¨ç½²ï¼š

```bash
# éƒ¨ç½²ç‰¹å®š function
supabase functions deploy generate-training-plan

# æˆ–éƒ¨ç½²å…¨éƒ¨
supabase functions deploy
```

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - æ·»åŠ å“åº”ç¼“å­˜ï¼ˆç›¸åŒå‚æ•°è¿”å›ç¼“å­˜ç»“æœï¼‰
   - ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹ï¼ˆå¦‚ qwen-turboï¼‰

2. **åŠŸèƒ½å¢å¼º**ï¼š
   - æ ¹æ®ç”¨æˆ·åé¦ˆè°ƒæ•´ prompt
   - æ”¯æŒæ›´å¤šè®­ç»ƒç›®æ ‡ï¼ˆå‡è‚¥ã€å¢è‚Œç­‰ï¼‰
   - æ”¯æŒè‡ªå®šä¹‰æ•™ç»ƒé£æ ¼

3. **æ•°æ®åˆ†æ**ï¼š
   - è®°å½• AI ç”Ÿæˆè´¨é‡
   - ç»Ÿè®¡ç”¨æˆ·æ»¡æ„åº¦
   - A/B æµ‹è¯•ä¸åŒ prompt
